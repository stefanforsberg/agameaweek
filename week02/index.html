<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<title>Title of the document</title>
	<style type="text/css">
		body {
			background-color: #000012;
			color: #ffffff;
		}

		.container {
			margin: auto;
			width: 642px;
			margin-top: 100px;
		}

		#game {
			cursor: none;
			border: solid 1px rgba(255,255,255,0.2);
		}
	</style>
</head>

<body>
	<div class="container">
		<p>Control rainbow robot with A/W/D. Aim with mouse and shoot with left mouse click.</p>
		<p>1. Avoid walls</p>
		<p>2. Avoid astorids</p>
		<p>3. Shoot astorids</p>
		<p>4. ???</p>
		<p>5. Profit</p>
		<p><input type="button" value="Click to start" id="start" /></p>
		<canvas id="game" width="640" height="480"></canvas>
	</div>

	<script type="text/javascript" src="rx.all.min.js"></script>
	<script type="text/javascript" src="player.js"></script>
	<script type="text/javascript" src="asteroid.js"></script>
	<script type="text/javascript" src="stars.js"></script>

	<script>
		var game = game || {};

		function ready(fn) {
		  if (document.readyState != 'loading'){
		    fn();
		  } else {
		    document.addEventListener('DOMContentLoaded', fn);
		  }
		}

		ready(init);

		function init() {
			game.settings = {
				width: 640,
				height: 480,
			}

			game.canvas = document.getElementById("game");
			game.context = game.canvas.getContext("2d");
		}

		document.getElementById("start").addEventListener("click", function () {
			start();
		});

		function start() {
			game.mapForMouseCoords = function(m) {
				return {
					x: (m.pageX - game.canvas.offsetLeft),
					y: (m.pageY - game.canvas.offsetTop)
				};
			}

			var gameEnded = new Rx.Subject();
			game.sources = {
				gameEnded: gameEnded,
				mouseMove: Rx.Observable.fromEvent(game.canvas, 'mousemove').takeUntil(gameEnded).map(game.mapForMouseCoords),
				mouseClick: Rx.Observable.fromEvent(game.canvas, 'click').takeUntil(gameEnded).map(game.mapForMouseCoords),
				keyDown: Rx.Observable.fromEvent(document, 'keydown').takeUntil(gameEnded),
				keyUp: Rx.Observable.fromEvent(document, 'keyup').takeUntil(gameEnded),
				tick: Rx.Observable.interval(33).takeUntil(gameEnded)
			}

			game.sounds = {
				explode: new Audio('explode.mp3'),
				song: new Audio('song.ogg')
			}

			game.sources.gameEnded.subscribe(function (x) {
				game.sounds.song.pause();

				game.sources.mouseMove.finally(console.log("cleaning up")).singleInstance()
			});

			game.sounds.song.loop = true;

			game.collides = function colCheck(shapeA, shapeB) {
	            // get the vectors to check against
	            var vX = (shapeA.x + (shapeA.w / 2)) - (shapeB.x + (shapeB.w / 2)),
	                vY = (shapeA.y + (shapeA.h / 2)) - (shapeB.y + (shapeB.h / 2)),
	                // add the half widths and half heights of the objects
	                hWidths = (shapeA.w / 2) + (shapeB.w / 2),
	                hHeights = (shapeA.h / 2) + (shapeB.h / 2),
	                colDir = null;

	            // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
	            if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
	                // figures out on which side we are colliding (top, bottom, left, or right)
	                var oX = hWidths - Math.abs(vX),
	                    oY = hHeights - Math.abs(vY);
	                if (oX >= oY) {
	                    if (vY > 0) {
	                        colDir = "t";
	                        shapeA.y += oY;
	                    } else {
	                        colDir = "b";
	                        shapeA.y -= oY;
	                    }
	                } else {
	                    if (vX > 0) {
	                        colDir = "l";
	                        shapeA.x += oX;
	                    } else {
	                        colDir = "r";
	                        shapeA.x -= oX;
	                    }
	                }
	            }
	            return colDir;
	        };

			var gun = {
				x: 0,
				y: 0,
				crosshairSize: 4,
				draw: function() {

					var k = (this.y - game.player.y)/(this.x - game.player.x);
					var m = this.y - (k*this.x);

					var y = k*10 + m;

					game.context.beginPath();
					game.context.strokeStyle="rgba(255,255,255,0.05)";
					game.context.moveTo(game.player.x + (game.player.w / 2),game.player.y + (game.player.h / 2));
					game.context.lineTo(this.x,this.y);

					game.context.stroke();

					game.context.strokeStyle="rgba(255,255,255,0.4)";

					game.context.moveTo(this.x-this.crosshairSize, this.y-this.crosshairSize);
					game.context.lineTo(this.x+this.crosshairSize,this.y+this.crosshairSize);

					game.context.moveTo(this.x+this.crosshairSize, this.y-this.crosshairSize);
					game.context.lineTo(this.x-this.crosshairSize,this.y+this.crosshairSize);

					game.context.stroke();

				}
			};
		

			game.sources.mouseMove.scan(function(g, m) {
				g.x = m.x;
				g.y = m.y;
				return g;
			}, gun).subscribe();

			game.player.init();
			game.asteroids.init();
			game.stars.init();

			game.sounds.song.play();

			game.sources.tick.subscribe(function () {
				game.context.fillStyle = "#000012";
				game.context.fillRect(0,0,game.settings.width,game.settings.height);
				
				game.stars.draw();
				game.asteroids.draw();
				gun.draw();
				game.player.draw();
			});	
		}

		





	</script>

</body>

</html>

